{% extends "students/base.html" %}
{% load static %}

{% block title %}انتهت الجلسة الأمنية (CSRF){% endblock %}

{% block content %}
<div class="container py-5">

  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">
      <div class="card border-0 shadow-sm overflow-hidden">

        <!-- رأس البطاقة -->
        <div class="bg-light p-4 text-center">
          <div style="font-size:64px; line-height:1; font-weight:800; letter-spacing:.05em;">403</div>
          <h1 class="h4 mt-2 mb-0">انتهت الجلسة الأمنيّة</h1>
          <p class="text-muted mb-0">تعذّر التحقّق من رمز الحماية (CSRF token).</p>
        </div>

        <!-- جسم البطاقة -->
        <div class="p-4 p-md-5">

          <!-- الشعار/الاسم (اختياري) -->
          {% if site.logo or site.school_name %}
          <div class="d-flex align-items-center gap-3 mb-4">
            {% if site.logo %}
              <img src="{{ site.logo.url }}" alt="شعار" style="height:48px;width:auto;border-radius:8px;background:#fff;padding:2px;">
            {% endif %}
            {% if site.school_name %}
              <strong class="fs-5">{{ site.school_name }}</strong>
            {% endif %}
          </div>
          {% endif %}

          <p class="mb-3">
            يحدث هذا عادةً إذا فُتح النموذج لمدّة طويلة ثم أُرسل، أو عند تعطيل الكوكيز،
            أو اختلاف النطاق/المنفذ، أو إرسال الطلب دون الرمز الأمني.
          </p>

          <!-- تلميحات سريعة للمستخدم -->
          <ul class="mb-4">
            <li>أعد تحميل الصفحة ثم أعد إرسال النموذج.</li>
            <li>تأكّد أنّ المتصفح يسمح بالكوكيز.</li>
            <li>إن كنت تعمل من تبويب قديم، افتح الصفحة من جديد.</li>
            <li>إن استمرّت المشكلة، جرّب تسجيل الخروج ثم الدخول مرة أخرى.</li>
          </ul>

          <!-- أزرار عملية -->
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary" onclick="location.reload()">تحديث الصفحة</button>
            <a href="{{ request.META.HTTP_REFERER|default:'/' }}" class="btn btn-primary">فتح النموذج من جديد</a>

            {% if request.user.is_authenticated %}
              <a href="/admin/" class="btn btn-light border">لوحة التحكم</a>
              <a href="{% url 'logout' %}?next={{ request.path|urlencode }}" class="btn btn-outline-danger">تسجيل الخروج</a>
            {% else %}
              <a href="/admin/login/?next={{ request.path|urlencode }}" class="btn btn-success">تسجيل الدخول</a>
            {% endif %}
          </div>

          <!-- تفاصيل تقنية (اختياري تظهر وقت التطوير) -->
          <hr class="my-4">
          <div class="small text-muted">
            {% if reason %}<div>السبب: <code dir="ltr">{{ reason }}</code></div>{% endif %}
            <div>المسار: <code dir="ltr">{{ request.path }}</code></div>
          </div>

        </div>

      </div>
    </div>
  </div>

</div>
{% endblock %}
